var tn={},Controller;tn.models={};tn.views={};tn.collections={};tn.api={};tn.updateStorage=function(posts,user,users){if(posts){store.set("posts",tn.collections.posts)}if(users){store.set("users",tn.collections.users)}if(user){store.set("currentUser",tn.currentUser)}};tn.models.User=Backbone.Model.extend({defaults:{about:"",pic:"",username:"",userImg:function(){return this.pic!==""?'<img src="'+this.pic+'" height="50" width="50" alt="" />':"<p>No Image Available</p>"},getLastId:function(){tn.collections.users.sortBy("id");return tn.collections.users.last().get("id")+1}}});tn.models.Post=Backbone.Model.extend({defaults:{comments:[],content:"",date:new Date,userAbout:function(){var user=tn.collections.users.get(this.userId);return user?user.get("about"):"No Bio"},userName:function(){var user=tn.collections.users.get(this.userId);return user?user.get("username"):"Unknown User"},userImg:function(){var user=tn.collections.users.get(this.userId);return user?'<img src="'+user.get("pic")+'" height="50" width="50" alt="" />':"<p>No Image Available</p>"},userImgComment:function(index){var user=tn.collections.users.get(this.comments[index].userId);return user?'<img src="'+user.get("pic")+'" height="25" width="25" alt="" />':"<p>No Image Available</p>"},userNameComment:function(index){var user=tn.collections.users.get(this.comments[index].userId);return user?user.get("username"):"Unknown User"},postDate:function(){if(this.date){var thisDate=new Date(this.date),tmpDate=new Date,dd=thisDate.getDate(),mm=thisDate.getMonth()+1,yyyy=thisDate.getFullYear(),formattedDate=(mm<10?"0"+mm:mm)+"/"+(dd<10?"0"+dd:dd)+"/"+yyyy;return thisDate.setHours(0,0,0,0)==tmpDate.setHours(0,0,0,0)?"Today":formattedDate}}}});tn.models.Comment=Backbone.Model.extend({defaults:{userId:"",postId:"",content:"",date:new Date,userName:function(){return tn.collections.users.get(this.userId).get("username")},userImg:function(){return'<img src="'+tn.collections.users.get(this.userId).get("pic")+'" height="50" width="50" alt="" />'}}});tn.collections.Users=Backbone.Collection.extend({model:tn.models.User,url:"/frontend-interview-test-long/codetest/data/users.json"});tn.collections.Posts=Backbone.Collection.extend({model:tn.models.Post,url:"/frontend-interview-test-long/codetest/data/posts.json"});tn.views.MainLayout=Mn.LayoutView.extend({el:"#appContainer",template:"#layout-view-template",regions:{header:"#header",main:"#page",footer:"#footer"}});tn.views.HeaderView=Mn.ItemView.extend({template:"#header-template",className:"group",ui:{postAnUpdate:"#postAnUpdate"},events:{"click @ui.postAnUpdate":"postAnUpdate"},postAnUpdate:function(){$("#modalBg").dialog({dialogClass:"noTitleStuff",resizable:false,width:320,modal:true,closeOnEscape:true,open:function(e){var $eTarget=$(e.target);$eTarget.find("textarea").keypress(function(e){if(e.keyCode==$.ui.keyCode.ENTER&&this.value!==""){tn.collections.posts.sortBy("id");tn.collections.posts.add(new tn.models.Post({id:tn.collections.posts.last().get("id")+1,content:this.value,userId:tn.currentUserId}));$eTarget.find("textarea").val("");$eTarget.dialog("close");tn.updateStorage(true)}})}})}});tn.views.FooterView=Mn.ItemView.extend({template:"#footer-template",ui:{clearLocal:".clearLocal"},events:{"click @ui.clearLocal":"clearLocal"},clearLocal:function(e){e.preventDefault();store.clear();window.location.reload()}});tn.views.PostView=Mn.ItemView.extend({template:"#post-template",ui:{addComment:".addCommentText"},events:{"keypress @ui.addComment":"addComment"},initialize:function(){this.listenTo(this.model,"addCommentEvt",this.addCommentEvt)},addCommentEvt:function(){var that=this;function isInPost(element){return element.postId==that.model.get("id")}this.model.set("comments",this.model.get("comments").filter(isInPost));this.render();tn.updateStorage(true)},addComment:function(e){if(e.keyCode==$.ui.keyCode.ENTER){var $ct=$(e.currentTarget),postModel=tn.collections.posts.get(this.model.get("id")),commentsArr=postModel.get("comments"),comment={content:$ct.val(),id:postModel.get("comments").length+1,postId:$ct.parents(".post").data("postId"),userId:tn.currentUserId};commentsArr.push(comment);postModel.set("comments",commentsArr);postModel.trigger("addCommentEvt")}}});tn.views.FeedView=Mn.CompositeView.extend({template:"#feed-template",childView:tn.views.PostView,childViewContainer:"#feedUl"});Controller=Mn.Controller.extend({home:function(){tn.views.mainLayout.getRegion("header").show(new tn.views.HeaderView({model:tn.currentUser}));tn.views.mainLayout.getRegion("main").show(new tn.views.FeedView({model:tn.currentUser,collection:tn.collections.posts}));tn.views.mainLayout.getRegion("footer").show(new tn.views.FooterView)},profile:function(){}});tn.Controller=new Controller;tn.Router=new Mn.AppRouter({controller:tn.Controller,appRoutes:{"":"home",profile:"profile"}});tn.App=new Mn.Application;tn.App.on("before:start",function(){tn.views.mainLayout=new tn.views.MainLayout;tn.views.mainLayout.render();tn.currentUserId=5});tn.App.on("start",function(){var getUsers=$.Deferred(),getPosts=$.Deferred();if(store.get("users")){tn.collections.users=new tn.collections.Users(store.get("users"));getUsers.resolve()}else{tn.collections.users=new tn.collections.Users({model:tn.models.User});tn.collections.users.fetch({success:function(){getUsers.resolve()}})}if(store.get("posts")){tn.collections.posts=new tn.collections.Posts(store.get("posts"));getPosts.resolve()}else{tn.collections.posts=new tn.collections.Posts({model:tn.models.Post});tn.collections.posts.fetch({success:function(){getPosts.resolve()}})}$.when(getPosts,getUsers).then(function(){tn.currentUser=tn.collections.users.get({id:tn.currentUserId});tn.updateStorage(true,true,true);Backbone.history.start()})});function initialize(){if(!store.enabled){$('<div class="storageError"><h1>Local storage is not supported by your browser.<br>'+'Please disable "Private Mode", or upgrade to a modern browser.<h1></div>').prependTo("body");$("body").addClass("storageBg");return}tn.App.start()}initialize();